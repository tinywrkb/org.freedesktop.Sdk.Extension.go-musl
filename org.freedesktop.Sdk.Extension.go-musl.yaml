id: org.freedesktop.Sdk.Extension.go-musl
branch: '22.08'
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
sdk-extensions:
  - org.freedesktop.Sdk.Extension.musl
build-options:
  cflags: -I/usr/lib/sdk/go-musl/include
  cxxflags: -I/usr/lib/sdk/go-musl/include
  ldflags: -L/usr/lib/sdk/go-musl/lib -Wl,--dynamic-linker=/usr/lib/sdk/go-musl/lib/libc.musl-x86_64.so.1
  prefix: /usr/lib/sdk/go-musl
  libdir: /usr/lib/sdk/go-musl/lib
  prepend-path: /usr/lib/sdk/go-musl/bin
  prepend-ld-library-path: /usr/lib/sdk/go-musl/lib
  prepend-pkg-config-path: /usr/lib/sdk/go-musl/lib/pkgconfig
  append-path: /usr/lib/sdk/musl/bin
  strip: true
  env:
    - AR=x86_64-linux-musl-ar
    - CC=x86_64-linux-musl-gcc
    - CXX=x86_64-linux-musl-g++
    - LD=x86_64-linux-musl-ld.mold
    - GOOS=linux

modules:
  - name: prepare-ccache
    buildsystem: simple
    build-commands:
      - |
        set -e
        if [ -n "$CCACHE_DIR" ]; then
          install -dm755 ${FLATPAK_DEST}/bin
          for cmp in gcc g++; do
            ln -s /usr/bin/ccache ${FLATPAK_DEST}/bin/x86_64-linux-musl-${cmp}
          done
        fi
    cleanup:
      - '*'

  - name: musl-libc-shared
    buildsystem: simple
    build-commands:
      - install -Dm755 /usr/lib/sdk/musl/${FLATPAK_ARCH}-linux-musl/lib/libc.so ${FLATPAK_DEST}/lib/libc.musl-${FLATPAK_ARCH}.so.1

  - name: go-musl-bootstrap
    build-options:
      cflags: -static
      cxxflags: -static
      #  go 1.4 executables generated by mold are broken when statically linking
     #ldflags: -static -Wl,-fuse-ld=mold
      ldflags: -static
      env:
        - CGO_ENABLED=0
        - GOVARS=
          GOPATH=${FLATPAK_BUILDER_BUILDDIR}
          GOROOT=${GOPATH}
          GOBIN=${GOROOT}/bin
          GOROOT_FINAL=${FLATPAK_DEST}/lib/go-bootstrap
        # go 1.4 executables generated by mold are broken when statically linking
       #- GO_LDFLAGS='-linkmode=external' '-extldflags=-static -Wl,-fuse-ld=mold'
        # this also break go 1.4
       #- GO_LDFLAGS='-linkmode=external' '-extldflags=-static'
    subdir: src
    buildsystem: simple
    build-commands:
      - sed -i '/^${CC/ s/\($mflag\)/\1 ${CFLAGS}/' make.bash
      - eval $GOVARS ./make.bash -v
      - install -dm755 ${FLATPAK_DEST}/lib/go-bootstrap
      - cp -r .. ${FLATPAK_DEST}/lib/go-bootstrap
    sources:
      - type: archive
        url: https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gz
        sha256: f4ff5b5eb3a3cae1c993723f3eab519c5bae18866b5e5f96fe1102f0cb5c3e52
        x-checker-data:
          type: html
          url: https://go.dev/doc/install/source
          version-pattern: go1.4-bootstrap-([\d\.-]+).tar.gz
          url-template: https://dl.google.com/go/go1.4-bootstrap-$version.tar.gz
    cleanup:
      - '*'

  - name: go-musl
    # TODO: remove unneeded files
    build-options:
      cflags: -static
      cxxflags: -static
      ldflags: -static -Wl,-fuse-ld=mold
      env:
        - GOVARS=
          GOPATH=${FLATPAK_BUILDER_BUILDDIR}
          GOROOT=${GOPATH}
          GOBIN=${GOROOT}/bin
          GOROOT_FINAL=${FLATPAK_DEST}/lib/go
          GOROOT_BOOTSTRAP=${FLATPAK_DEST}/lib/go-bootstrap
       #- GO_EXTLINK_ENABLED=1
        - GO_CFLAGS=-tags osusergo,netgo,static -buildmode=pie
       #- GO_GCFLAGS=
       #- 'GO_LDFLAGS=-linkmode=external -extldflags="-static-pie -Wl,--dynamic-linker=/usr/lib/sdk/go-musl/lib/libc.musl-x86_64.so.1"'
        - GO_LDFLAGS='-linkmode=external' '-extldflags=-static -Wl,-fuse-ld=mold'
       #- CGO_CFLAGS=-static
       #- CGO_LDFLAGS=-static -Wl,--dynamic-linker=/usr/lib/sdk/go-musl/lib/libc.musl-x86_64.so.1
    subdir: src
    buildsystem: simple
    build-commands:
      - eval $GOVARS ./make.bash -v
      - install -dm755 ${FLATPAK_DEST}/{bin,lib/go}
      # remove ppc binaries that strip failing to recongnize and then exit with an error
      - rm -f runtime/pprof/testdata/test{32,64}be
      - cp -r .. ${FLATPAK_DEST}/lib/go
      - ln -s ../lib/go/bin/go{,fmt} -t ${FLATPAK_DEST}/bin/
    sources:
      - type: archive
        url: https://go.dev/dl/go1.19.src.tar.gz
        sha256: 9419cc70dc5a2523f29a77053cafff658ed21ef3561d9b6b020280ebceab28b9
        x-checker-data:
          type: anitya
          project-id: 1227
          stable-only: true
          url-template: https://go.dev/dl/go$version.src.tar.gz

  - name: packaging
    buildsystem: simple
    build-commands:
      - install -Dm755 enable.sh -t ${FLATPAK_DEST}/
    sources:
      - type: script
        dest-filename: enable.sh
        commands:
          - |
            SDKPATH=/usr/lib/sdk/go-musl
            export PATH=${SDKPATH}/bin:$PATH
            if [ -z "$LD_LIBRARY_PATH" ]; then
              export LD_LIBRARY_PATH=${SDKPATH}/lib
            else
              export LD_LIBRARY_PATH+=:${SDKPATH}/lib
            fi
